# =============================================================================
# Ecency Self-Hosted Blog - Docker Compose Configuration
# =============================================================================
# Quick start:
#   1. Copy config.template.json to config.json
#   2. Edit config.json with your settings
#   3. Run: docker-compose up -d
#
# For production with SSL, use docker-compose.production.yml
# =============================================================================

services:
  blog:
    build:
      context: ../..
      dockerfile: apps/self-hosted/Dockerfile
      args:
        # Inject config at build time (optional)
        # CONFIG_JSON: ${CONFIG_JSON:-}
    image: ecency/self-hosted:latest
    container_name: ecency-blog
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:80"
    volumes:
      # Mount config.json for runtime configuration updates
      # Changes to config.json will be reflected without rebuilding
      - ./config.json:/usr/share/nginx/html/config.json:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    labels:
      - "com.ecency.service=self-hosted-blog"

# =============================================================================
# Production configuration with Traefik (optional)
# Uncomment the following to enable automatic HTTPS with Let's Encrypt
# =============================================================================
#
#   blog:
#     # ... same as above, but remove ports mapping
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.blog.rule=Host(`yourdomain.com`)"
#       - "traefik.http.routers.blog.entrypoints=websecure"
#       - "traefik.http.routers.blog.tls.certresolver=letsencrypt"
#       - "traefik.http.services.blog.loadbalancer.server.port=80"
#
#   traefik:
#     image: traefik:v3.0
#     container_name: traefik
#     restart: unless-stopped
#     command:
#       - "--api.insecure=false"
#       - "--providers.docker=true"
#       - "--providers.docker.exposedbydefault=false"
#       - "--entrypoints.web.address=:80"
#       - "--entrypoints.websecure.address=:443"
#       - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
#       - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
#       - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
#       - "--certificatesresolvers.letsencrypt.acme.email=your-email@example.com"
#       - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
#     ports:
#       - "80:80"
#       - "443:443"
#     volumes:
#       - "/var/run/docker.sock:/var/run/docker.sock:ro"
#       - "letsencrypt:/letsencrypt"
#
# volumes:
#   letsencrypt:
